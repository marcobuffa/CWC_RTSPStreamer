<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="stylesheet" href="css/main.css" />
		<title>RTSP Video Stream CWC</title>
		<script type="text/javascript" src="libs/jsmpeg.min.js"></script>
		<script src="./libs/webcc.min.js"></script>
	</head>
	<body>
		<div id="container" class="player">
			<div id="video-container" class="video"></div>
		</div>
		
		<script type="text/javascript">
		    let jsmpegPlayer;
			const videoContainer = document.getElementById('video-container');
			var ievdIP = "192.168.1.100";
			var streamUrl = "rtsp://192.168.1.104:8554/mystream";

			function startStream() {
				console.log("Trying to fetch http://"+ievdIP+":33030/start");
				fetch(`http://${ievdIP}:33030/start`, {
					method: 'POST',
					headers: {'Content-Type': 'application/json;charset=utf-8'},
					body: JSON.stringify({streamUrl, ievdIP})
				})
				.then((response) => response.json())
				.then((data) => {
					if (jsmpegPlayer) {
						jsmpegPlayer.stop();
						jsmpegPlayer.destroy();
					}

					const canvas = document.createElement('canvas');
					canvas.id = 'jsmpeg-player';
					document.getElementById('video-container').appendChild(canvas);

					console.log("Websockets url: " + data.url);

					jsmpegPlayer = new JSMpeg.Player(data.url, {
						canvas,
						autoplay: true,
						audio: false,
					})
				})
			}

			function setProperty() {
				ievdIP = WebCC.Properties.EdgeServerAddress;
				streamUrl = WebCC.Properties.MediaRTSPPath;
				startStream();
			}

			WebCC.start(
				function(result) {
					if (result) {
						console.log("I'm in WinCC :-)");
						WebCC.onPropertyChanged.subscribe(setProperty);
						setProperty();
					} else {
						console.log("Let me alone: I'm not in WinCC :-(");
						startStream();
					}
				},
				{
                    methods: {},
                    events: [],
                    properties: {
						MediaRTSPPath: 'rtsp://192.168.0.100:8554/mystream',
						EdgeServerAddress: '127.0.0.1'
					}
                },
				["HMI"],
				10000
			);
		</script>
	</body>
</html>
